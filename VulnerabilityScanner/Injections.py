import requests
from bs4 import BeautifulSoup as bs
from abc import abstractmethod


class Injections:

    def __init__(self, quiet):
        self.quiet = quiet

    @staticmethod
    def get_all_forms_html(quiet, url):
        """
        Retrieve all HTML forms from a given URL
        Args:
            url: URL to  site
            quiet: mode of scanner
        Returns: All forms present on page

        """
        if not quiet:
            print("[*] Getting html forms")
        req = requests.get(url).content
        soup = bs(req, 'html.parser')
        return soup.find_all('form')

    @staticmethod
    def get_form_details(form):
        """
        Extract and return details of a given form
        Returns: Action, method and inputs of given form
        """
        details_form = {}               # Dictionary for action, method and input
        action = form.attrs.get('action').lower()
        method = form.attrs.get('method', 'get').lower()
        form_inputs = []

        # Handle input tags
        for tag in form.find_all("input"):
            input_type = tag.attrs.get("type", "text")
            input_name = tag.attrs.get("name")
            input_value = tag.attrs.get("value", "")
            form_inputs.append({"type": input_type, "name": input_name, "value": input_value})

        # Handle textarea tags
        for tag in form.find_all("textarea"):
            input_name = tag.attrs.get("name")
            input_value = tag.get_text()
            form_inputs.append({"type": "textarea", "name": input_name, "value": input_value})

        # Handle select tags and assume first option selected if no 'selected' attribute present
        for tag in form.find_all("select"):
            input_name = tag.attrs.get("name")
            options = tag.find_all("option")
            selected_value = ""
            for option in options:
                if 'selected' in option.attrs:
                    selected_value = option.attrs.get("value", "")
                    break
            if not selected_value and options:
                selected_value = options[0].attrs.get("value", "")
            form_inputs.append({"type": "select", "name": input_name, "value": selected_value})

        # Put everything to resulting dictionary
        details_form["action"] = action
        details_form["method"] = method
        details_form["inputs"] = form_inputs

        return details_form

    @abstractmethod
    def scan_host(self, *args, **kwargs):
        pass
