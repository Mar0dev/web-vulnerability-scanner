import subprocess
import shlex
from urllib.parse import urlparse


class CommonPortsCheck:

    def __init__(self, quiet):
        self.quiet = quiet

    def scan_ports(self, url, report):
        """
        Scan ports of provided URL with nmap
        Args:
            url: URL of site to be scanned
            report: Report file object
        """
        if not self.quiet:
            print("[*] Scanning common ports using nmap")

        # Prepare url for nmap
        parsed_url = urlparse(url)
        host = parsed_url.hostname

        # Execute nmap command and write formatted output to report
        nmap_command = f"nmap -F {host}"
        safe_command = shlex.split(nmap_command)
        try:
            result = subprocess.run(safe_command, capture_output=True, text=True, check=True)
            report.write_to_report("\n [*****] Scanning common ports with nmap [*****] \n \n")
            report.write_to_report(result.stdout)
        except subprocess.CalledProcessError as e:
            print(f"An error occurred while scanning ports: {e}")
        except FileNotFoundError:
            print("nmap is not installed or not found in PATH.")

        if not self.quiet:
            print("[*] Common ports have been scanned!")
